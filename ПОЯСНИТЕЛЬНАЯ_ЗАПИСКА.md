# ПОЯСНИТЕЛЬНАЯ ЗАПИСКА

## Система обмена знаниями "KnowledgeForKnowledgeLite"

**Разработчик:** [Ваше имя]  
**Дата:** 2024  
**Назначение проекта:** Дипломная/курсовая работа

---

## 1. Назначение разрабатываемой программы

### 1.1. Целевая аудитория

Разрабатываемая программа предназначена для **студентов высших учебных заведений**, которые хотят обмениваться знаниями и навыками на основе принципа бартера.

### 1.2. Проблема, которую решает система

В процессе обучения студенты сталкиваются с ситуациями, когда:
- Они хорошо знают один предмет (например, линейную алгебру), но испытывают трудности с другим (например, математическим анализом)
- Им нужна помощь в изучении определенной дисциплины, но они не могут оплатить услуги репетитора
- Они готовы помочь другим студентам своими знаниями в обмен на помощь в другой области

**Пример использования:**
Студент А хорошо знает линейную алгебру, но испытывает сложности с математическим анализом. Студент Б отлично разбирается в матанализе, но нуждается в помощи по линейной алгебре. Система позволяет им найти друг друга и обменяться знаниями: студент А помогает Б с линалом, а Б помогает А с матаном.

### 1.3. Как система будет использоваться

1. **Регистрация и создание профиля:**
   - Пользователь регистрируется в системе
   - Заполняет профиль с информацией о себе
   - Указывает свои навыки и уровень владения ими

2. **Добавление навыков:**
   - Пользователь добавляет навыки из каталога (например, "Линейная алгебра", "Программирование на Python")
   - Указывает свой уровень владения (Beginner, Intermediate, Advanced, Expert)
   - Может загрузить подтверждающие документы (дипломы, сертификаты, проекты)

3. **Верификация навыков:**
   - Администраторы проверяют загруженные документы
   - Подтверждают уровень владения навыком

4. **Публикация предложений и запросов:**
   - Пользователь может опубликовать **предложение** (Offer): "Готов помочь с линейной алгеброй"
   - Пользователь может опубликовать **запрос** (Request): "Нужна помощь с математическим анализом"

5. **Поиск и установление контакта:**
   - Система позволяет искать пользователей по навыкам
   - Пользователи могут просматривать профили и контактировать друг с другом
   - Обмен знаниями происходит вне системы (через указанные контакты)

---

## 2. Функциональные требования

На основе предназначения системы вытекают следующие функциональные требования:

### 2.1. Управление пользователями

**FR-1.** Система должна обеспечивать регистрацию новых пользователей с указанием логина (email) и пароля.

**FR-2.** Система должна обеспечивать аутентификацию пользователей по логину и паролю.

**FR-3.** Система должна поддерживать роли пользователей: обычный пользователь и администратор.

**FR-4.** Система должна поддерживать мягкое удаление пользователей (soft delete).

**FR-5.** Система должна хранить информацию о последнем входе пользователя в систему.

### 2.2. Управление профилями

**FR-6.** Система должна позволять пользователю создавать и редактировать свой профиль:
   - Полное имя
   - Дата рождения
   - Фотография профиля
   - Описание (до 3000 символов)
   - Контактная информация (email, телефон, социальные сети)

**FR-7.** Система должна позволять настраивать видимость контактной информации (публичная/приватная).

**FR-8.** Система должна отслеживать время последнего визита пользователя (LastSeenOnline).

### 2.3. Управление навыками

**FR-9.** Система должна поддерживать каталог навыков, организованный по категориям.

**FR-10.** Система должна позволять пользователю добавлять навыки из каталога к своему профилю.

**FR-11.** Система должна поддерживать стандартизированные уровни владения навыком (Beginner, Intermediate, Advanced, Expert).

**FR-12.** Система должна позволять указывать опыт работы со навыком в годах.

**FR-13.** Пользователь может иметь несколько навыков, каждый навык может иметь несколько пользователей.

**FR-14.** Система должна отслеживать верифицированные навыки пользователя.

### 2.4. Верификация навыков

**FR-15.** Система должна позволять пользователю загружать подтверждающие документы (дипломы, сертификаты, портфолио).

**FR-16.** Система должна поддерживать верификацию документов администраторами.

**FR-17.** Система должна хранить информацию о том, кто и когда верифицировал документ.

**FR-18.** Система должна поддерживать различные статусы документов: Pending, Approved, Rejected, Expired.

**FR-19.** Система должна поддерживать журнал запросов на верификацию.

### 2.5. Образование

**FR-20.** Система должна позволять пользователю указывать информацию об образовании:
   - Название учебного заведения
   - Специальность
   - Годы обучения
   - Уровень образования

### 2.6. Публикация предложений и запросов

**FR-21.** Система должна позволять пользователю публиковать **предложения** (готов помочь с навыком).

**FR-22.** Система должна позволять пользователю публиковать **запросы** (нужна помощь с навыком).

**FR-23.** Система должна поддерживать поиск предложений и запросов по навыкам.

**FR-24.** Система должна поддерживать различные статусы постов: Active, Closed, Cancelled, Expired.

**FR-25.** Система должна поддерживать мягкое удаление постов.

**FR-26.** Система должна отслеживать количество просмотров поста.

**FR-27.** Каждый пост связан ровно с одним пользователем (автором) и ровно с одним навыком.

### 2.7. Поиск и фильтрация

**FR-28.** Система должна позволять искать пользователей по навыкам.

**FR-29.** Система должна позволять фильтровать пользователей по уровню владения навыком.

**FR-30.** Система должна позволять искать активные предложения и запросы.

### 2.8. Аудит

**FR-31.** Система должна логировать все значимые действия пользователей (логин, добавление навыка, публикация поста, верификация).

---

## 3. Нефункциональные требования

### 3.1. Требования к пользователям

**Кто сможет использовать систему:**

1. **Студенты:**
   - Возраст: от 16 лет
   - Требования: наличие email-адреса, базовые навыки работы с веб-браузером
   - Образование: студенты вузов, колледжей, а также лица, получающие дополнительное образование

2. **Администраторы:**
   - Требования: назначение администратором существующим администратором
   - Права: верификация документов, модерация контента, управление каталогом навыков

3. **Гостевые пользователи:**
   - Могут просматривать публичные профили и активные предложения/запросы
   - Не могут создавать посты или добавлять навыки без регистрации

### 3.2. Технические требования

**NFR-1.** Система должна поддерживать не менее 10 000 зарегистрированных пользователей.

**NFR-2.** Время отклика системы на запрос поиска не должно превышать 2 секунды.

**NFR-3.** Система должна поддерживать одновременную работу не менее 100 пользователей.

**NFR-4.** Данные должны храниться в реляционной базе данных с поддержкой транзакций.

**NFR-5.** Пароли должны храниться в хэшированном виде (BCrypt/Argon2).

**NFR-6.** Система должна обеспечивать целостность данных через внешние ключи и ограничения.

**NFR-7.** Система должна поддерживать резервное копирование данных.

**NFR-8.** Система должна логировать все действия администраторов.

---

## 4. Предварительная схема базы данных

### 4.1. ER-диаграмма (текстовое представление)

```
┌──────────────┐
│   Accounts   │
│──────────────│
│ AccountID (PK)│
│ Login (UK)   │
│ PasswordHash │
│ IsAdmin      │
│ EmailConfirmed│
│ LastLoginAt  │
│ ...          │
└──────┬───────┘
       │ 1
       │
       │ 1
┌──────▼───────┐
│ UserProfiles │
│──────────────│
│ AccountID(PK)│
│ FullName     │
│ DateOfBirth  │
│ PhotoURL     │
│ Description  │
│ ...          │
└──────────────┘

┌──────────────┐       ┌──────────────┐
│   Accounts   │ 1    *│ UserContacts │
│              │◄──────│              │
└──────┬───────┘       └──────────────┘
       │ 1
       │
       │ *
┌──────▼──────────────┐
│    UserSkills       │
│─────────────────────│
│ AccountID (PK, FK)  │
│ SkillID (PK, FK)    │
│ SkillLevelID (FK)   │
│ IsVerified          │
│ ExperienceYears     │
└──────┬──────────────┘
       │ *
       │
       │ 1
┌──────▼──────────────┐
│   SkillsCatalog     │
│─────────────────────│
│ SkillID (PK)        │
│ SkillName           │
│ CategoryID (FK)     │
└──────┬──────────────┘
       │ *
       │
       │ 1
┌──────▼──────────────┐
│  SkillCategories    │
│─────────────────────│
│ CategoryID (PK)     │
│ Name                │
└─────────────────────┘

┌──────────────┐       ┌──────────────┐
│   Accounts   │ 1    *│  SkillPosts  │
│              │◄──────│              │
└──────┬───────┘       └──────┬───────┘
       │                      │ *
       │                      │
       │                      │ 1
       │              ┌───────▼──────────┐
       │              │  SkillsCatalog   │
       │              └──────────────────┘
       │
       │ 1
       │
       │ *
┌──────▼──────────────┐
│      Proofs         │
│─────────────────────│
│ ProofID (PK)        │
│ AccountID (FK)      │
│ SkillID (FK, NULL)  │
│ FileURL             │
│ Status              │
│ VerifiedBy (FK)     │
└─────────────────────┘

┌──────────────┐       ┌──────────────┐
│   Accounts   │ 1    *│  Education   │
│              │◄──────│              │
└──────────────┘       └──────────────┘

┌──────────────┐       ┌─────────────────────┐
│   Accounts   │ 1    *│ VerificationRequests│
│              │◄──────│                     │
└──────────────┘       └─────────────────────┘
```

### 4.2. Список сущностей и их атрибутов

#### 4.2.1. Accounts (Аккаунты)
- AccountID (PK)
- Login (UK)
- PasswordHash
- IsAdmin
- EmailConfirmed
- LastLoginAt
- PasswordUpdatedAt
- CreatedAt
- UpdatedAt
- DeletedAt (soft delete)

#### 4.2.2. UserProfiles (Профили пользователей)
- AccountID (PK, FK → Accounts)
- FullName
- DateOfBirth
- PhotoURL
- Description
- LastSeenOnline
- IsActive
- CreatedAt
- UpdatedAt

#### 4.2.3. UserContacts (Контакты)
- ContactID (PK)
- AccountID (FK → Accounts)
- ContactType
- ContactValue
- IsPublic
- DisplayOrder
- CreatedAt
- UpdatedAt

#### 4.2.4. SkillCategories (Категории навыков)
- CategoryID (PK)
- Name (UK)
- Description
- IconURL
- DisplayOrder
- IsActive
- CreatedAt
- UpdatedAt

#### 4.2.5. SkillsCatalog (Каталог навыков)
- SkillID (PK)
- SkillName
- CategoryID (FK → SkillCategories)
- Description
- IsActive
- CreatedAt
- UpdatedAt

#### 4.2.6. SkillLevels (Уровни навыков)
- LevelID (PK)
- Name (UK)
- Rank (UK)
- Description
- CreatedAt
- UpdatedAt

#### 4.2.7. UserSkills (Навыки пользователей)
- AccountID (PK, FK → Accounts)
- SkillID (PK, FK → SkillsCatalog)
- SkillLevelID (FK → SkillLevels)
- IsVerified
- VerifiedAt
- ExperienceYears
- CreatedAt
- UpdatedAt

#### 4.2.8. Education (Образование)
- EducationID (PK)
- AccountID (FK → Accounts)
- InstitutionName
- DegreeField
- YearStarted
- YearCompleted
- DegreeLevel
- IsCurrent
- CreatedAt
- UpdatedAt

#### 4.2.9. Proofs (Документы)
- ProofID (PK)
- AccountID (FK → Accounts)
- SkillID (FK → SkillsCatalog, NULL)
- EducationID (FK → Education, NULL)
- FileURL
- FileName
- FileSize
- MimeType
- Status
- VerifiedBy (FK → Accounts, NULL)
- VerifiedAt
- RejectionReason
- ExpiresAt
- CreatedAt
- UpdatedAt

#### 4.2.10. SkillPosts (Посты о навыках)
- PostID (PK)
- AccountID (FK → Accounts)
- SkillID (FK → SkillsCatalog)
- PostType (Offer/Request)
- Title
- Details
- Status
- ContactPreference
- ExpiresAt
- ViewsCount
- CreatedAt
- UpdatedAt
- DeletedAt (soft delete)

#### 4.2.11. VerificationRequests (Запросы на верификацию)
- RequestID (PK)
- AccountID (FK → Accounts)
- ProofID (FK → Proofs)
- RequestType
- Status
- RequestMessage
- ReviewNotes
- CreatedAt
- ReviewedBy (FK → Accounts, NULL)
- ReviewedAt
- UpdatedAt

#### 4.2.12. AuditLog (Журнал аудита)
- LogID (PK)
- ActorAccountID (FK → Accounts, NULL)
- Action
- EntityType
- EntityID
- Details (JSON)
- IPAddress
- UserAgent
- Result
- ErrorMessage
- CreatedAt

### 4.3. Связи между сущностями

1. **Accounts ↔ UserProfiles:** 1:1 (один аккаунт — один профиль)
2. **Accounts ↔ UserContacts:** 1:* (один аккаунт — много контактов)
3. **Accounts ↔ UserSkills:** 1:* (один пользователь — много навыков)
4. **Accounts ↔ SkillPosts:** 1:* (один пользователь — много постов)
5. **Accounts ↔ Education:** 1:* (один пользователь — много записей об образовании)
6. **Accounts ↔ Proofs:** 1:* (один пользователь — много документов)
7. **Accounts ↔ VerificationRequests:** 1:* (один пользователь — много запросов)
8. **SkillCategories ↔ SkillsCatalog:** 1:* (одна категория — много навыков)
9. **SkillsCatalog ↔ UserSkills:** 1:* (один навык — много пользователей)
10. **SkillsCatalog ↔ SkillPosts:** 1:* (один навык — много постов)
11. **SkillLevels ↔ UserSkills:** 1:* (один уровень — много пользователей)
12. **Proofs ↔ VerificationRequests:** 1:* (один документ — много запросов)

---

## 5. Текстовые ограничения на данные

На основе функциональных требований вытекают следующие ограничения:

### 5.1. Ограничения целостности

**OC-1.** Один аккаунт имеет ровно один профиль пользователя (UserProfile). Один профиль принадлежит ровно одному аккаунту.

**OC-2.** Один аккаунт может иметь 0 или более контактов (UserContacts). Каждый контакт принадлежит ровно одному аккаунту.

**OC-3.** Один пользователь (Account) может иметь 0 или более навыков (UserSkills). Один навык может принадлежать 0 или более пользователям (связь многие-ко-многим).

**OC-4.** Каждый навык пользователя (UserSkills) имеет ровно один уровень владения (SkillLevel). Один уровень может быть присвоен 0 или более навыкам пользователей.

**OC-5.** Один пост (SkillPost) принадлежит ровно одному пользователю (Account) и связан ровно с одним навыком (SkillsCatalog). Один пользователь может создать 0 или более постов. Один навык может быть упомянут в 0 или более постах.

**OC-6.** Один документ (Proof) принадлежит ровно одному пользователю (Account). Документ может быть связан с 0 или 1 навыком (SkillID может быть NULL) и с 0 или 1 записью об образовании (EducationID может быть NULL), но хотя бы одна из этих связей должна существовать.

**OC-7.** Одна категория навыков (SkillCategory) может содержать 0 или более навыков (SkillsCatalog). Один навык принадлежит ровно одной категории.

**OC-8.** Один запрос на верификацию (VerificationRequest) связан ровно с одним документом (Proof) и ровно с одним пользователем (Account). Один документ может иметь 0 или более запросов на верификацию.

### 5.2. Ограничения значений

**OC-9.** Логин (Accounts.Login) должен быть уникальным в системе.

**OC-10.** Название навыка (SkillsCatalog.SkillName) должно быть уникальным в пределах категории (UNIQUE(SkillName, CategoryID)).

**OC-11.** Уровень навыка (SkillLevels.Rank) должен быть уникальным (для корректной сортировки).

**OC-12.** Описание профиля (UserProfiles.Description) не должно превышать 3000 символов.

**OC-13.** Описание поста (SkillPosts.Details) не должно превышать 5000 символов.

**OC-14.** Год начала обучения (Education.YearStarted) должен быть в диапазоне от 1900 до 2100.

**OC-15.** Год окончания обучения (Education.YearCompleted) должен быть в диапазоне от 1900 до 2100, и если указан, то должен быть больше или равен году начала (YearCompleted >= YearStarted).

**OC-16.** Опыт работы со навыком (UserSkills.ExperienceYears) должен быть в диапазоне от 0 до 100 лет.

**OC-17.** Тип поста (SkillPosts.PostType) может иметь только значения 'Offer' или 'Request'.

**OC-18.** Статус поста (SkillPosts.Status) может иметь только значения 'Active', 'Closed', 'Cancelled', 'Expired'.

**OC-19.** Статус документа (Proofs.Status) может иметь только значения 'Pending', 'Approved', 'Rejected', 'Expired'.

### 5.3. Ограничения бизнес-логики

**OC-20.** Пользователь не может удалить навык из каталога (SkillsCatalog), если существуют активные посты, связанные с этим навыком (RESTRICT).

**OC-21.** Пользователь не может удалить категорию навыков, если в ней есть навыки (RESTRICT).

**OC-22.** Пользователь не может удалить уровень навыка, если есть пользователи с этим уровнем (RESTRICT).

**OC-23.** При удалении пользователя (Account) должны каскадно удаляться его профиль, контакты, навыки, посты, образование, документы и запросы на верификацию (CASCADE).

**OC-24.** При удалении навыка из каталога связь с документом должна обнуляться (SET NULL), но документ остается.

---

## 6. Функциональные и многозначные зависимости

### 6.1. Функциональные зависимости (FD)

#### Таблица Accounts:
- `AccountID → Login, PasswordHash, IsAdmin, EmailConfirmed, LastLoginAt, PasswordUpdatedAt, CreatedAt, UpdatedAt, DeletedAt`
- `Login → AccountID` (обратная зависимость из-за UNIQUE)

#### Таблица UserProfiles:
- `AccountID → FullName, DateOfBirth, PhotoURL, Description, LastSeenOnline, IsActive, CreatedAt, UpdatedAt`

#### Таблица UserContacts:
- `ContactID → AccountID, ContactType, ContactValue, IsPublic, DisplayOrder, CreatedAt, UpdatedAt`
- `AccountID, ContactType, ContactValue → ContactID` (предполагается уникальность комбинации для одного пользователя)

#### Таблица SkillCategories:
- `CategoryID → Name, Description, IconURL, DisplayOrder, IsActive, CreatedAt, UpdatedAt`
- `Name → CategoryID` (обратная зависимость из-за UNIQUE)

#### Таблица SkillsCatalog:
- `SkillID → SkillName, CategoryID, Description, IsActive, CreatedAt, UpdatedAt`
- `CategoryID, SkillName → SkillID` (обратная зависимость из-за UNIQUE(CategoryID, SkillName))

#### Таблица SkillLevels:
- `LevelID → Name, Rank, Description, CreatedAt, UpdatedAt`
- `Name → LevelID` (обратная зависимость из-за UNIQUE)
- `Rank → LevelID` (обратная зависимость из-за UNIQUE)

#### Таблица UserSkills:
- `AccountID, SkillID → SkillLevelID, IsVerified, VerifiedAt, ExperienceYears, CreatedAt, UpdatedAt`
- Это составной ключ, поэтому все неключевые атрибуты функционально зависят от него

#### Таблица Education:
- `EducationID → AccountID, InstitutionName, DegreeField, YearStarted, YearCompleted, DegreeLevel, IsCurrent, CreatedAt, UpdatedAt`

#### Таблица Proofs:
- `ProofID → AccountID, SkillID, EducationID, FileURL, FileName, FileSize, MimeType, Status, VerifiedBy, VerifiedAt, RejectionReason, ExpiresAt, CreatedAt, UpdatedAt`

#### Таблица SkillPosts:
- `PostID → AccountID, SkillID, PostType, Title, Details, Status, ContactPreference, ExpiresAt, ViewsCount, CreatedAt, UpdatedAt, DeletedAt`

#### Таблица VerificationRequests:
- `RequestID → AccountID, ProofID, RequestType, Status, RequestMessage, ReviewNotes, CreatedAt, ReviewedBy, ReviewedAt, UpdatedAt`

#### Таблица AuditLog:
- `LogID → ActorAccountID, Action, EntityType, EntityID, Details, IPAddress, UserAgent, Result, ErrorMessage, CreatedAt`

### 6.2. Многозначные зависимости (MVD)

В нормализованной схеме многозначные зависимости устранены через декомпозицию. Однако можно выделить следующие потенциальные MVD, которые были решены:

#### До нормализации (гипотетическая объединенная таблица UserData):

Если бы все данные пользователя хранились в одной таблице:
- `AccountID ↠ ContactType, ContactValue | SkillID, SkillLevelID | EducationID`

Это означало бы, что контакты, навыки и образование независимы друг от друга для одного пользователя.

**Решение:** Разделение на отдельные таблицы UserContacts, UserSkills, Education.

#### Для таблицы Proofs:

- `ProofID ↠ SkillID | EducationID` — документ может быть связан с навыком ИЛИ с образованием, но не с обоими одновременно.

**Решение:** Оба поля могут быть NULL, но не могут быть заполнены одновременно (требуется проверка на уровне приложения или CHECK-ограничение).

---

## 7. Нормализация схемы базы данных

### 7.1. Цель нормализации

Нормализация предназначена для:
- Устранения избыточности данных
- Предотвращения аномалий вставки, обновления и удаления
- Обеспечения целостности данных
- Упрощения поддержки базы данных

### 7.2. Процесс нормализации

#### Шаг 1: Первая нормальная форма (1NF)

**Требования:** Все атрибуты должны быть атомарными, не должно быть повторяющихся групп.

**Проверка схемы:**

✅ **Accounts, UserProfiles, SkillCategories, SkillsCatalog, SkillLevels** — все атрибуты атомарны.

✅ **UserContacts** — контакты вынесены в отдельную таблицу, что устраняет повторяющиеся группы (ContactType1, ContactValue1, ContactType2, ContactValue2...).

✅ **UserSkills** — навыки вынесены в отдельную таблицу, что устраняет повторяющиеся группы.

✅ **Education** — записи об образовании вынесены в отдельную таблицу.

✅ **SkillPosts** — все атрибуты атомарны.

**Вывод:** Схема соответствует 1NF.

#### Шаг 2: Вторая нормальная форма (2NF)

**Требования:** Таблица должна быть в 1NF, и все неключевые атрибуты должны полностью зависеть от всего составного ключа (если он есть).

**Проверка схемы:**

✅ **UserSkills (AccountID, SkillID)** — составной ключ. Все неключевые атрибуты (SkillLevelID, IsVerified, ExperienceYears) зависят от полного ключа. Нельзя определить уровень навыка только по AccountID или только по SkillID.

**Вывод:** Схема соответствует 2NF.

#### Шаг 3: Третья нормальная форма (3NF)

**Требования:** Таблица должна быть в 2NF, и не должно быть транзитивных зависимостей (неключевой атрибут зависит от другого неключевого атрибута).

**Проверка потенциальных транзитивных зависимостей:**

✅ **UserProfiles:** Все атрибуты зависят только от AccountID (ключ), транзитивных зависимостей нет.

✅ **SkillsCatalog:** Все атрибуты зависят от SkillID. CategoryID является внешним ключом, но не создает транзитивную зависимость (название категории хранится в SkillCategories, а не в SkillsCatalog).

✅ **UserSkills:** Все неключевые атрибуты зависят от полного ключа (AccountID, SkillID). SkillLevelID — внешний ключ, но не создает транзитивную зависимость (название уровня хранится в SkillLevels).

✅ **SkillPosts:** Все атрибуты зависят от PostID. AccountID и SkillID — внешние ключи, но не создают транзитивных зависимостей.

**Вывод:** Схема соответствует 3NF.

#### Шаг 4: Нормальная форма Бойса-Кодда (BCNF)

**Требования:** Таблица должна быть в 3NF, и каждая детерминанта (левая часть функциональной зависимости) должна быть потенциальным ключом.

**Проверка:**

✅ **Accounts:** Login является детерминантой (Login → AccountID) и является уникальным ключом (UK), что соответствует BCNF.

✅ **SkillCategories:** Name является детерминантой и является уникальным ключом, что соответствует BCNF.

✅ **SkillsCatalog:** (CategoryID, SkillName) является детерминантой и является составным уникальным ключом, что соответствует BCNF.

✅ **SkillLevels:** Name и Rank являются детерминантами и являются уникальными ключами, что соответствует BCNF.

**Вывод:** Схема соответствует BCNF.

#### Шаг 5: Четвертая нормальная форма (4NF)

**Требования:** Таблица должна быть в BCNF, и не должно быть нетривиальных многозначных зависимостей.

**Проверка:**

✅ Все многозначные зависимости устранены через декомпозицию:
- Контакты вынесены в UserContacts
- Навыки вынесены в UserSkills
- Образование вынесено в Education

**Вывод:** Схема соответствует 4NF.

### 7.3. Итоговый вывод по нормализации

Схема базы данных нормализована до **4NF** (четвертой нормальной формы), что означает:
- Устранены все аномалии обновления и удаления
- Минимизирована избыточность данных
- Обеспечена целостность данных
- Упрощена поддержка базы данных

---

## 8. Пример недонормализованной схемы и аномалий

### 8.1. Недонормализованная схема

Рассмотрим альтернативный вариант, где данные пользователя, его навыки и контакты хранятся в одной таблице:

```sql
CREATE TABLE UserData (
    AccountID BIGINT PRIMARY KEY,
    Login VARCHAR(100),
    FullName VARCHAR(150),
    Email VARCHAR(255),
    Phone VARCHAR(20),
    Telegram VARCHAR(100),
    Skill1 VARCHAR(100),
    Skill1Level VARCHAR(50),
    Skill2 VARCHAR(100),
    Skill2Level VARCHAR(50),
    Skill3 VARCHAR(100),
    Skill3Level VARCHAR(50)
);
```

**Проблемы этой схемы:**
1. Ограниченное количество навыков (только 3)
2. Избыточность при хранении контактов
3. Нарушение 1NF (повторяющиеся группы)

### 8.2. Более реалистичная недонормализованная схема

Рассмотрим схему, где навыки пользователя и информация о навыке хранятся вместе:

```sql
CREATE TABLE UserSkillsDenormalized (
    AccountID BIGINT,
    SkillID BIGINT,
    SkillName VARCHAR(100),
    CategoryID BIGINT,
    CategoryName VARCHAR(100),
    SkillLevelID BIGINT,
    LevelName VARCHAR(50),
    LevelRank INT,
    IsVerified BOOLEAN,
    ExperienceYears DECIMAL(3,1),
    PRIMARY KEY (AccountID, SkillID)
);
```

В нормализованной схеме эти данные разделены на таблицы:
- UserSkills (AccountID, SkillID, SkillLevelID, IsVerified, ExperienceYears)
- SkillsCatalog (SkillID, SkillName, CategoryID)
- SkillCategories (CategoryID, CategoryName)
- SkillLevels (LevelID, LevelName, LevelRank)

### 8.3. Аномалии недонормализованной схемы

#### Аномалия обновления (Update Anomaly)

**Сценарий:** Необходимо изменить название навыка "Python Programming" на "Python Development" для всех пользователей.

**В недонормализованной схеме:**
```sql
-- Нужно обновить все строки, где встречается этот навык
UPDATE UserSkillsDenormalized 
SET SkillName = 'Python Development' 
WHERE SkillName = 'Python Programming';
-- Если забыть обновить хотя бы одну строку, возникнет несогласованность данных
```

**Проблема:** 
- Необходимо обновить множество строк
- Высокий риск ошибки (можно пропустить некоторые записи)
- Избыточное использование ресурсов БД

**В нормализованной схеме:**
```sql
-- Обновляется только одна запись
UPDATE SkillsCatalog 
SET SkillName = 'Python Development' 
WHERE SkillID = 123;
-- Все связанные записи автоматически "увидят" новое название через JOIN
```

#### Аномалия вставки (Insertion Anomaly)

**Сценарий:** Необходимо добавить новый навык "Machine Learning" в каталог, но пока ни один пользователь его не имеет.

**В недонормализованной схеме:**
```sql
-- Невозможно вставить навык без привязки к пользователю
-- Нужно создать "фиктивного" пользователя или использовать NULL-значения
INSERT INTO UserSkillsDenormalized (SkillID, SkillName, CategoryID, CategoryName)
VALUES (999, 'Machine Learning', 5, 'Data Science');
-- Но AccountID не может быть NULL (это часть первичного ключа)
```

**Проблема:**
- Невозможно добавить навык в каталог без привязки к пользователю
- Нарушение логики данных

**В нормализованной схеме:**
```sql
-- Можно легко добавить навык в каталог
INSERT INTO SkillsCatalog (SkillID, SkillName, CategoryID)
VALUES (999, 'Machine Learning', 5);
-- Пользователи могут добавлять этот навык позже
```

#### Аномалия удаления (Deletion Anomaly)

**Сценарий:** Последний пользователь с навыком "COBOL" удаляет этот навык из своего профиля. Навык должен остаться в каталоге.

**В недонормализованной схеме:**
```sql
-- Удаление навыка пользователя
DELETE FROM UserSkillsDenormalized 
WHERE AccountID = 100 AND SkillID = 50;
-- Если это был последний пользователь с этим навыком, информация о навыке теряется
-- Навык "исчезает" из каталога, хотя должен оставаться доступным
```

**Проблема:**
- Потеря информации о навыке при удалении последней связи с пользователем
- Невозможность восстановления навыка без внешних источников

**В нормализованной схеме:**
```sql
-- Удаление навыка пользователя
DELETE FROM UserSkills 
WHERE AccountID = 100 AND SkillID = 50;
-- Навык остается в SkillsCatalog и доступен для других пользователей
```

#### Аномалия хранения (Storage Anomaly)

**Сценарий:** Пользователь имеет 10 навыков, каждый с полной информацией о категории и уровне.

**В недонормализованной схеме:**
- Каждая строка дублирует название категории, название уровня, ранг уровня
- Если категория "Programming" упоминается 1000 раз у разных пользователей, её название хранится 1000 раз
- Избыточное использование дискового пространства

**В нормализованной схеме:**
- Название категории хранится один раз в SkillCategories
- Название уровня хранится один раз в SkillLevels
- Экономия дискового пространства и обеспечение согласованности данных

### 8.4. Вывод

Нормализованная схема устраняет все перечисленные аномалии:
- ✅ Обновление данных происходит в одном месте
- ✅ Можно добавлять сущности независимо от связей
- ✅ Удаление связи не приводит к потере информации о сущности
- ✅ Минимизирована избыточность данных

---

## 9. Преобразование нормализованной схемы в SQL DDL

Ниже представлен SQL DDL скрипт для создания всех таблиц базы данных:

```sql
-- ============================================
-- База данных: KnowledgeForKnowledgeLite
-- Описание: Система обмена знаниями для студентов
-- ============================================

-- Удаление существующих таблиц (в обратном порядке зависимостей)
DROP TABLE IF EXISTS AuditLog;
DROP TABLE IF EXISTS VerificationRequests;
DROP TABLE IF EXISTS SkillPosts;
DROP TABLE IF EXISTS Proofs;
DROP TABLE IF EXISTS Education;
DROP TABLE IF EXISTS UserSkills;
DROP TABLE IF EXISTS UserContacts;
DROP TABLE IF EXISTS UserProfiles;
DROP TABLE IF EXISTS SkillsCatalog;
DROP TABLE IF EXISTS SkillLevels;
DROP TABLE IF EXISTS SkillCategories;
DROP TABLE IF EXISTS Accounts;

-- ============================================
-- 1. Таблица Accounts (Аккаунты)
-- ============================================
CREATE TABLE Accounts (
    AccountID BIGINT PRIMARY KEY AUTO_INCREMENT,
    Login VARCHAR(100) NOT NULL UNIQUE,
    PasswordHash VARCHAR(255) NOT NULL,
    IsAdmin BOOLEAN NOT NULL DEFAULT FALSE,
    EmailConfirmed BOOLEAN NOT NULL DEFAULT FALSE,
    LastLoginAt DATETIME NULL,
    PasswordUpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    DeletedAt DATETIME NULL,
    
    INDEX idx_accounts_deleted_at (DeletedAt),
    INDEX idx_accounts_is_admin (IsAdmin)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 2. Таблица UserProfiles (Профили пользователей)
-- ============================================
CREATE TABLE UserProfiles (
    AccountID BIGINT PRIMARY KEY,
    FullName VARCHAR(150) NULL,
    DateOfBirth DATE NULL,
    PhotoURL VARCHAR(500) NULL,
    Description TEXT NULL,
    LastSeenOnline DATETIME NULL,
    IsActive BOOLEAN NOT NULL DEFAULT TRUE,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_user_profiles_description_length 
        CHECK (LENGTH(Description) <= 3000),
    CONSTRAINT fk_user_profiles_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    
    INDEX idx_user_profiles_full_name (FullName),
    INDEX idx_user_profiles_is_active (IsActive)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 3. Таблица UserContacts (Контакты)
-- ============================================
CREATE TABLE UserContacts (
    ContactID BIGINT PRIMARY KEY AUTO_INCREMENT,
    AccountID BIGINT NOT NULL,
    ContactType VARCHAR(50) NOT NULL,
    ContactValue VARCHAR(255) NOT NULL,
    IsPublic BOOLEAN NOT NULL DEFAULT FALSE,
    DisplayOrder INT NOT NULL DEFAULT 0,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_user_contacts_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    CONSTRAINT chk_user_contacts_type 
        CHECK (ContactType IN ('Email', 'Phone', 'Telegram', 'WhatsApp', 'LinkedIn', 'GitHub', 'Other')),
    
    INDEX idx_user_contacts_account_id (AccountID),
    INDEX idx_user_contacts_type (ContactType, IsPublic)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 4. Таблица SkillCategories (Категории навыков)
-- ============================================
CREATE TABLE SkillCategories (
    CategoryID BIGINT PRIMARY KEY AUTO_INCREMENT,
    Name VARCHAR(100) NOT NULL UNIQUE,
    Description TEXT NULL,
    IconURL VARCHAR(500) NULL,
    DisplayOrder INT NOT NULL DEFAULT 0,
    IsActive BOOLEAN NOT NULL DEFAULT TRUE,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_skill_categories_active (IsActive, DisplayOrder)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 5. Таблица SkillLevels (Уровни навыков)
-- ============================================
CREATE TABLE SkillLevels (
    LevelID BIGINT PRIMARY KEY AUTO_INCREMENT,
    Name VARCHAR(50) NOT NULL UNIQUE,
    Rank INT NOT NULL UNIQUE,
    Description TEXT NULL,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_skill_levels_rank_sort (Rank)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 6. Таблица SkillsCatalog (Каталог навыков)
-- ============================================
CREATE TABLE SkillsCatalog (
    SkillID BIGINT PRIMARY KEY AUTO_INCREMENT,
    SkillName VARCHAR(100) NOT NULL,
    CategoryID BIGINT NOT NULL,
    Description TEXT NULL,
    IsActive BOOLEAN NOT NULL DEFAULT TRUE,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_skills_catalog_category 
        FOREIGN KEY (CategoryID) REFERENCES SkillCategories(CategoryID) 
        ON DELETE RESTRICT,
    
    UNIQUE INDEX idx_skills_catalog_name_category (SkillName, CategoryID),
    INDEX idx_skills_catalog_category_id (CategoryID),
    INDEX idx_skills_catalog_active (IsActive, SkillName)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 7. Таблица UserSkills (Навыки пользователей)
-- ============================================
CREATE TABLE UserSkills (
    AccountID BIGINT NOT NULL,
    SkillID BIGINT NOT NULL,
    SkillLevelID BIGINT NOT NULL,
    IsVerified BOOLEAN NOT NULL DEFAULT FALSE,
    VerifiedAt DATETIME NULL,
    ExperienceYears DECIMAL(3,1) NULL,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (AccountID, SkillID),
    CONSTRAINT fk_user_skills_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    CONSTRAINT fk_user_skills_skill 
        FOREIGN KEY (SkillID) REFERENCES SkillsCatalog(SkillID) 
        ON DELETE CASCADE,
    CONSTRAINT fk_user_skills_level 
        FOREIGN KEY (SkillLevelID) REFERENCES SkillLevels(LevelID) 
        ON DELETE RESTRICT,
    CONSTRAINT chk_user_skills_experience 
        CHECK (ExperienceYears IS NULL OR (ExperienceYears >= 0 AND ExperienceYears <= 100)),
    
    INDEX idx_user_skills_skill_id (SkillID),
    INDEX idx_user_skills_account_id (AccountID),
    INDEX idx_user_skills_verified (IsVerified, SkillID)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 8. Таблица Education (Образование)
-- ============================================
CREATE TABLE Education (
    EducationID BIGINT PRIMARY KEY AUTO_INCREMENT,
    AccountID BIGINT NOT NULL,
    InstitutionName VARCHAR(150) NOT NULL,
    DegreeField VARCHAR(100) NOT NULL,
    YearStarted INT NULL,
    YearCompleted INT NULL,
    DegreeLevel VARCHAR(50) NULL,
    IsCurrent BOOLEAN NOT NULL DEFAULT FALSE,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_education_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    CONSTRAINT chk_education_year_started 
        CHECK (YearStarted IS NULL OR (YearStarted >= 1900 AND YearStarted <= 2100)),
    CONSTRAINT chk_education_year_completed 
        CHECK (YearCompleted IS NULL OR (YearCompleted >= 1900 AND YearCompleted <= 2100)),
    CONSTRAINT chk_education_years 
        CHECK (YearCompleted IS NULL OR YearStarted IS NULL OR YearCompleted >= YearStarted),
    CONSTRAINT chk_education_degree_level 
        CHECK (DegreeLevel IS NULL OR DegreeLevel IN ('Bachelor', 'Master', 'PhD', 'Certificate', 'Other')),
    
    INDEX idx_education_account_id (AccountID),
    INDEX idx_education_year_completed (YearCompleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 9. Таблица Proofs (Документы)
-- ============================================
CREATE TABLE Proofs (
    ProofID BIGINT PRIMARY KEY AUTO_INCREMENT,
    AccountID BIGINT NOT NULL,
    SkillID BIGINT NULL,
    EducationID BIGINT NULL,
    FileURL VARCHAR(500) NOT NULL,
    FileName VARCHAR(255) NULL,
    FileSize BIGINT NULL,
    MimeType VARCHAR(100) NULL,
    Status VARCHAR(20) NOT NULL DEFAULT 'Pending',
    VerifiedBy BIGINT NULL,
    VerifiedAt DATETIME NULL,
    RejectionReason TEXT NULL,
    ExpiresAt DATETIME NULL,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_proofs_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    CONSTRAINT fk_proofs_skill 
        FOREIGN KEY (SkillID) REFERENCES SkillsCatalog(SkillID) 
        ON DELETE SET NULL,
    CONSTRAINT fk_proofs_education 
        FOREIGN KEY (EducationID) REFERENCES Education(EducationID) 
        ON DELETE SET NULL,
    CONSTRAINT fk_proofs_verified_by 
        FOREIGN KEY (VerifiedBy) REFERENCES Accounts(AccountID) 
        ON DELETE SET NULL,
    CONSTRAINT chk_proofs_status 
        CHECK (Status IN ('Pending', 'Approved', 'Rejected', 'Expired')),
    CONSTRAINT chk_proofs_skill_or_education 
        CHECK (SkillID IS NOT NULL OR EducationID IS NOT NULL),
    
    INDEX idx_proofs_account_id (AccountID),
    INDEX idx_proofs_skill_id (SkillID),
    INDEX idx_proofs_status (Status, CreatedAt),
    INDEX idx_proofs_verified_by (VerifiedBy)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 10. Таблица SkillPosts (Посты о навыках)
-- ============================================
CREATE TABLE SkillPosts (
    PostID BIGINT PRIMARY KEY AUTO_INCREMENT,
    AccountID BIGINT NOT NULL,
    SkillID BIGINT NOT NULL,
    PostType VARCHAR(20) NOT NULL,
    Title VARCHAR(100) NOT NULL,
    Details TEXT NOT NULL,
    Status VARCHAR(20) NOT NULL DEFAULT 'Active',
    ContactPreference VARCHAR(50) NULL,
    ExpiresAt DATETIME NULL,
    ViewsCount INT NOT NULL DEFAULT 0,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    DeletedAt DATETIME NULL,
    
    CONSTRAINT fk_skill_posts_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    CONSTRAINT fk_skill_posts_skill 
        FOREIGN KEY (SkillID) REFERENCES SkillsCatalog(SkillID) 
        ON DELETE RESTRICT,
    CONSTRAINT chk_skill_posts_type 
        CHECK (PostType IN ('Offer', 'Request')),
    CONSTRAINT chk_skill_posts_status 
        CHECK (Status IN ('Active', 'Closed', 'Cancelled', 'Expired')),
    CONSTRAINT chk_skill_posts_details_length 
        CHECK (LENGTH(Details) <= 5000),
    
    INDEX idx_skill_posts_skill_status (SkillID, Status),
    INDEX idx_skill_posts_type (PostType, Status),
    INDEX idx_skill_posts_account_id (AccountID),
    INDEX idx_skill_posts_created_at (CreatedAt DESC),
    INDEX idx_skill_posts_deleted_at (DeletedAt)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 11. Таблица VerificationRequests (Запросы на верификацию)
-- ============================================
CREATE TABLE VerificationRequests (
    RequestID BIGINT PRIMARY KEY AUTO_INCREMENT,
    AccountID BIGINT NOT NULL,
    ProofID BIGINT NOT NULL,
    RequestType VARCHAR(30) NOT NULL,
    Status VARCHAR(20) NOT NULL DEFAULT 'Pending',
    RequestMessage TEXT NULL,
    ReviewNotes TEXT NULL,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ReviewedBy BIGINT NULL,
    ReviewedAt DATETIME NULL,
    UpdatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_verification_requests_account 
        FOREIGN KEY (AccountID) REFERENCES Accounts(AccountID) 
        ON DELETE CASCADE,
    CONSTRAINT fk_verification_requests_proof 
        FOREIGN KEY (ProofID) REFERENCES Proofs(ProofID) 
        ON DELETE CASCADE,
    CONSTRAINT fk_verification_requests_reviewed_by 
        FOREIGN KEY (ReviewedBy) REFERENCES Accounts(AccountID) 
        ON DELETE SET NULL,
    CONSTRAINT chk_verification_requests_type 
        CHECK (RequestType IN ('SkillVerification', 'EducationVerification', 'ProfileVerification')),
    CONSTRAINT chk_verification_requests_status 
        CHECK (Status IN ('Pending', 'InReview', 'Approved', 'Rejected', 'Cancelled')),
    
    INDEX idx_verification_requests_account_id (AccountID),
    INDEX idx_verification_requests_proof_id (ProofID),
    INDEX idx_verification_requests_status (Status, CreatedAt),
    INDEX idx_verification_requests_reviewed_by (ReviewedBy)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- 12. Таблица AuditLog (Журнал аудита)
-- ============================================
CREATE TABLE AuditLog (
    LogID BIGINT PRIMARY KEY AUTO_INCREMENT,
    ActorAccountID BIGINT NULL,
    Action VARCHAR(100) NOT NULL,
    EntityType VARCHAR(50) NOT NULL,
    EntityID BIGINT NULL,
    Details JSON NULL,
    IPAddress VARCHAR(45) NULL,
    UserAgent VARCHAR(500) NULL,
    Result VARCHAR(20) NULL,
    ErrorMessage TEXT NULL,
    CreatedAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_audit_log_actor 
        FOREIGN KEY (ActorAccountID) REFERENCES Accounts(AccountID) 
        ON DELETE SET NULL,
    CONSTRAINT chk_audit_log_result 
        CHECK (Result IS NULL OR Result IN ('Success', 'Failure', 'Error')),
    
    INDEX idx_audit_log_actor (ActorAccountID, CreatedAt DESC),
    INDEX idx_audit_log_entity (EntityType, EntityID),
    INDEX idx_audit_log_action (Action, CreatedAt DESC),
    INDEX idx_audit_log_created_at (CreatedAt DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ============================================
-- Заполнение справочных данных
-- ============================================

-- Добавление уровней навыков
INSERT INTO SkillLevels (Name, Rank, Description) VALUES
('Beginner', 1, 'Начальный уровень - базовые знания'),
('Intermediate', 2, 'Средний уровень - уверенное владение'),
('Advanced', 3, 'Продвинутый уровень - глубокие знания'),
('Expert', 4, 'Экспертный уровень - признанный специалист');

-- Добавление категорий навыков
INSERT INTO SkillCategories (Name, Description, DisplayOrder) VALUES
('Mathematics', 'Математические дисциплины', 1),
('Programming', 'Программирование и разработка', 2),
('Languages', 'Иностранные языки', 3),
('Science', 'Естественные науки', 4),
('Arts', 'Искусство и творчество', 5),
('Other', 'Прочее', 99);

-- Добавление навыков в каталог (примеры)
INSERT INTO SkillsCatalog (SkillName, CategoryID, Description) VALUES
('Linear Algebra', (SELECT CategoryID FROM SkillCategories WHERE Name = 'Mathematics'), 'Линейная алгебра'),
('Mathematical Analysis', (SELECT CategoryID FROM SkillCategories WHERE Name = 'Mathematics'), 'Математический анализ'),
('Python Programming', (SELECT CategoryID FROM SkillCategories WHERE Name = 'Programming'), 'Программирование на Python'),
('Java Programming', (SELECT CategoryID FROM SkillCategories WHERE Name = 'Programming'), 'Программирование на Java'),
('English Language', (SELECT CategoryID FROM SkillCategories WHERE Name = 'Languages'), 'Английский язык'),
('German Language', (SELECT CategoryID FROM SkillCategories WHERE Name = 'Languages'), 'Немецкий язык');
```

---

## 10. SQL DML запросы, реализующие функциональные требования

### 10.1. Управление пользователями (FR-1, FR-2, FR-4, FR-5)

#### FR-1: Регистрация нового пользователя
```sql
-- Регистрация пользователя
INSERT INTO Accounts (Login, PasswordHash, EmailConfirmed, CreatedAt)
VALUES ('student@university.edu', '$2b$10$hashedpassword', FALSE, NOW());

-- Создание профиля при регистрации
INSERT INTO UserProfiles (AccountID, FullName, IsActive, CreatedAt)
VALUES (LAST_INSERT_ID(), 'Иван Иванов', TRUE, NOW());
```

#### FR-2: Аутентификация пользователя
```sql
-- Проверка логина и пароля (хэш проверяется в приложении)
SELECT AccountID, Login, PasswordHash, IsAdmin, EmailConfirmed, DeletedAt
FROM Accounts
WHERE Login = 'student@university.edu' 
  AND DeletedAt IS NULL;
```

#### FR-5: Обновление времени последнего входа
```sql
UPDATE Accounts
SET LastLoginAt = NOW()
WHERE AccountID = 1;
```

#### FR-4: Мягкое удаление пользователя
```sql
UPDATE Accounts
SET DeletedAt = NOW()
WHERE AccountID = 1;
```

### 10.2. Управление профилями (FR-6, FR-7, FR-8)

#### FR-6: Создание/редактирование профиля
```sql
-- Обновление профиля
UPDATE UserProfiles
SET FullName = 'Иван Петров',
    DateOfBirth = '2000-01-15',
    PhotoURL = 'https://example.com/photo.jpg',
    Description = 'Студент 3 курса, изучаю программирование',
    UpdatedAt = NOW()
WHERE AccountID = 1;
```

#### FR-7: Добавление контакта с настройкой видимости
```sql
INSERT INTO UserContacts (AccountID, ContactType, ContactValue, IsPublic, DisplayOrder)
VALUES (1, 'Email', 'ivan@example.com', TRUE, 1),
       (1, 'Telegram', '@ivan_petrov', TRUE, 2),
       (1, 'Phone', '+7-900-123-45-67', FALSE, 3);
```

#### FR-8: Обновление времени последнего визита
```sql
UPDATE UserProfiles
SET LastSeenOnline = NOW()
WHERE AccountID = 1;
```

### 10.3. Управление навыками (FR-9, FR-10, FR-11, FR-12, FR-13)

#### FR-10: Добавление навыка пользователю
```sql
-- Получение SkillID и LevelID
SET @skill_id = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = 'Python Programming');
SET @level_id = (SELECT LevelID FROM SkillLevels WHERE Name = 'Intermediate');

-- Добавление навыка
INSERT INTO UserSkills (AccountID, SkillID, SkillLevelID, IsVerified, ExperienceYears, CreatedAt)
VALUES (1, @skill_id, @level_id, FALSE, 2.5, NOW())
ON DUPLICATE KEY UPDATE
    SkillLevelID = @level_id,
    ExperienceYears = 2.5,
    UpdatedAt = NOW();
```

#### FR-13: Получение всех навыков пользователя
```sql
SELECT 
    sc.SkillName,
    sc.Description AS SkillDescription,
    cat.Name AS CategoryName,
    sl.Name AS LevelName,
    sl.Rank AS LevelRank,
    us.IsVerified,
    us.ExperienceYears,
    us.CreatedAt AS AddedAt
FROM UserSkills us
JOIN SkillsCatalog sc ON us.SkillID = sc.SkillID
JOIN SkillCategories cat ON sc.CategoryID = cat.CategoryID
JOIN SkillLevels sl ON us.SkillLevelID = sl.LevelID
WHERE us.AccountID = 1
ORDER BY cat.DisplayOrder, sc.SkillName;
```

### 10.4. Верификация навыков (FR-15, FR-16, FR-17, FR-18)

#### FR-15: Загрузка подтверждающего документа
```sql
SET @skill_id = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = 'Python Programming');

INSERT INTO Proofs (
    AccountID, 
    SkillID, 
    FileURL, 
    FileName, 
    FileSize, 
    MimeType, 
    Status,
    CreatedAt
)
VALUES (
    1, 
    @skill_id, 
    'https://storage.example.com/proofs/certificate_123.pdf',
    'Python_Certificate.pdf',
    2048576,
    'application/pdf',
    'Pending',
    NOW()
);
```

#### FR-16: Верификация документа администратором
```sql
UPDATE Proofs
SET Status = 'Approved',
    VerifiedBy = 999, -- ID администратора
    VerifiedAt = NOW(),
    UpdatedAt = NOW()
WHERE ProofID = 1;

-- Обновление статуса навыка пользователя
UPDATE UserSkills
SET IsVerified = TRUE,
    VerifiedAt = NOW(),
    UpdatedAt = NOW()
WHERE AccountID = 1 
  AND SkillID = (SELECT SkillID FROM Proofs WHERE ProofID = 1);
```

#### FR-17: Получение информации о верификаторе
```sql
SELECT 
    p.ProofID,
    p.FileName,
    p.Status,
    p.VerifiedAt,
    a.Login AS VerifiedByLogin,
    up.FullName AS VerifiedByName
FROM Proofs p
LEFT JOIN Accounts a ON p.VerifiedBy = a.AccountID
LEFT JOIN UserProfiles up ON a.AccountID = up.AccountID
WHERE p.ProofID = 1;
```

### 10.5. Образование (FR-20)

#### FR-20: Добавление информации об образовании
```sql
INSERT INTO Education (
    AccountID,
    InstitutionName,
    DegreeField,
    YearStarted,
    YearCompleted,
    DegreeLevel,
    IsCurrent,
    CreatedAt
)
VALUES (
    1,
    'Московский Государственный Университет',
    'Прикладная математика и информатика',
    2018,
    2022,
    'Bachelor',
    FALSE,
    NOW()
);
```

### 10.6. Публикация предложений и запросов (FR-21, FR-22, FR-23, FR-24)

#### FR-21: Публикация предложения (Offer)
```sql
SET @skill_id = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = 'Linear Algebra');

INSERT INTO SkillPosts (
    AccountID,
    SkillID,
    PostType,
    Title,
    Details,
    Status,
    ContactPreference,
    ExpiresAt,
    CreatedAt
)
VALUES (
    1,
    @skill_id,
    'Offer',
    'Помощь с линейной алгеброй',
    'Готов помочь с решением задач по линейной алгебре. Изучаю предмет на отлично, могу объяснить сложные темы простым языком.',
    'Active',
    'Telegram',
    DATE_ADD(NOW(), INTERVAL 30 DAY),
    NOW()
);
```

#### FR-22: Публикация запроса (Request)
```sql
SET @skill_id = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = 'Mathematical Analysis');

INSERT INTO SkillPosts (
    AccountID,
    SkillID,
    PostType,
    Title,
    Details,
    Status,
    ContactPreference,
    ExpiresAt,
    CreatedAt
)
VALUES (
    2,
    @skill_id,
    'Request',
    'Нужна помощь с математическим анализом',
    'Ищу студента, который хорошо разбирается в матанализе и готов помочь с подготовкой к экзамену. Взамен могу помочь с программированием на Python.',
    'Active',
    'Email',
    DATE_ADD(NOW(), INTERVAL 14 DAY),
    NOW()
);
```

#### FR-23: Поиск предложений и запросов по навыку
```sql
-- Поиск активных предложений по навыку
SELECT 
    sp.PostID,
    sp.PostType,
    sp.Title,
    sp.Details,
    sp.ContactPreference,
    sp.CreatedAt,
    up.FullName AS AuthorName,
    sc.SkillName,
    sl.Name AS AuthorSkillLevel
FROM SkillPosts sp
JOIN Accounts a ON sp.AccountID = a.AccountID
JOIN UserProfiles up ON a.AccountID = up.AccountID
JOIN SkillsCatalog sc ON sp.SkillID = sc.SkillID
LEFT JOIN UserSkills us ON a.AccountID = us.AccountID AND sp.SkillID = us.SkillID
LEFT JOIN SkillLevels sl ON us.SkillLevelID = sl.LevelID
WHERE sp.SkillID = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = 'Linear Algebra')
  AND sp.Status = 'Active'
  AND sp.DeletedAt IS NULL
  AND sp.PostType = 'Offer'
ORDER BY sp.CreatedAt DESC;
```

#### FR-24: Изменение статуса поста
```sql
UPDATE SkillPosts
SET Status = 'Closed',
    UpdatedAt = NOW()
WHERE PostID = 1;
```

### 10.7. Поиск и фильтрация (FR-28, FR-29, FR-30)

#### FR-28: Поиск пользователей по навыку
```sql
SELECT DISTINCT
    a.AccountID,
    up.FullName,
    up.PhotoURL,
    up.Description,
    sl.Name AS SkillLevel,
    sl.Rank AS LevelRank,
    us.IsVerified,
    us.ExperienceYears,
    up.LastSeenOnline
FROM Accounts a
JOIN UserProfiles up ON a.AccountID = up.AccountID
JOIN UserSkills us ON a.AccountID = us.AccountID
JOIN SkillsCatalog sc ON us.SkillID = sc.SkillID
JOIN SkillLevels sl ON us.SkillLevelID = sl.LevelID
WHERE sc.SkillName = 'Python Programming'
  AND a.DeletedAt IS NULL
  AND up.IsActive = TRUE
ORDER BY sl.Rank DESC, us.IsVerified DESC, up.LastSeenOnline DESC;
```

#### FR-29: Фильтрация по уровню владения навыком
```sql
SELECT 
    a.AccountID,
    up.FullName,
    sl.Name AS SkillLevel,
    us.IsVerified
FROM Accounts a
JOIN UserProfiles up ON a.AccountID = up.AccountID
JOIN UserSkills us ON a.AccountID = us.AccountID
JOIN SkillsCatalog sc ON us.SkillID = sc.SkillID
JOIN SkillLevels sl ON us.SkillLevelID = sl.LevelID
WHERE sc.SkillName = 'Linear Algebra'
  AND sl.Rank >= 3  -- Advanced или Expert
  AND us.IsVerified = TRUE
  AND a.DeletedAt IS NULL
ORDER BY sl.Rank DESC;
```

### 10.8. Аудит (FR-31)

#### FR-31: Логирование действий пользователей
```sql
-- Логирование входа пользователя
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    IPAddress,
    UserAgent,
    Result,
    CreatedAt
)
VALUES (
    1,
    'UserLogin',
    'Account',
    1,
    '192.168.1.1',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    'Success',
    NOW()
);

-- Логирование добавления навыка
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    Details,
    Result,
    CreatedAt
)
VALUES (
    1,
    'SkillAdded',
    'UserSkill',
    LAST_INSERT_ID(),
    JSON_OBJECT('SkillID', 5, 'SkillName', 'Python Programming', 'Level', 'Intermediate'),
    'Success',
    NOW()
);
```

---

## 11. Группировка запросов в транзакции

### 11.1. Транзакция регистрации пользователя

```sql
START TRANSACTION;

-- Вставка аккаунта
INSERT INTO Accounts (Login, PasswordHash, EmailConfirmed, CreatedAt)
VALUES ('newstudent@university.edu', '$2b$10$hashedpassword', FALSE, NOW());

SET @new_account_id = LAST_INSERT_ID();

-- Создание профиля
INSERT INTO UserProfiles (AccountID, FullName, IsActive, CreatedAt)
VALUES (@new_account_id, 'Новый Студент', TRUE, NOW());

-- Логирование
INSERT INTO AuditLog (ActorAccountID, Action, EntityType, EntityID, Result, CreatedAt)
VALUES (@new_account_id, 'UserRegistered', 'Account', @new_account_id, 'Success', NOW());

COMMIT;
-- В случае ошибки: ROLLBACK;
```

### 11.2. Транзакция добавления навыка с документом

```sql
START TRANSACTION;

SET @account_id = 1;
SET @skill_id = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = 'Python Programming');
SET @level_id = (SELECT LevelID FROM SkillLevels WHERE Name = 'Intermediate');

-- Добавление навыка
INSERT INTO UserSkills (AccountID, SkillID, SkillLevelID, IsVerified, ExperienceYears, CreatedAt)
VALUES (@account_id, @skill_id, @level_id, FALSE, 2.0, NOW())
ON DUPLICATE KEY UPDATE
    SkillLevelID = @level_id,
    ExperienceYears = 2.0,
    UpdatedAt = NOW();

SET @user_skill_id = LAST_INSERT_ID();

-- Загрузка документа
INSERT INTO Proofs (
    AccountID, 
    SkillID, 
    FileURL, 
    FileName, 
    FileSize, 
    MimeType, 
    Status,
    CreatedAt
)
VALUES (
    @account_id,
    @skill_id,
    'https://storage.example.com/proofs/cert_123.pdf',
    'Python_Certificate.pdf',
    1024000,
    'application/pdf',
    'Pending',
    NOW()
);

SET @proof_id = LAST_INSERT_ID();

-- Создание запроса на верификацию
INSERT INTO VerificationRequests (
    AccountID,
    ProofID,
    RequestType,
    Status,
    RequestMessage,
    CreatedAt
)
VALUES (
    @account_id,
    @proof_id,
    'SkillVerification',
    'Pending',
    'Прошу верифицировать мой сертификат по Python',
    NOW()
);

-- Логирование
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    Details,
    Result,
    CreatedAt
)
VALUES (
    @account_id,
    'SkillAddedWithProof',
    'UserSkill',
    @user_skill_id,
    JSON_OBJECT('SkillID', @skill_id, 'ProofID', @proof_id),
    'Success',
    NOW()
);

COMMIT;
```

### 11.3. Транзакция верификации документа администратором

```sql
START TRANSACTION;

SET @proof_id = 1;
SET @admin_id = 999;
SET @decision = 'Approved'; -- или 'Rejected'

-- Обновление статуса документа
UPDATE Proofs
SET Status = @decision,
    VerifiedBy = @admin_id,
    VerifiedAt = NOW(),
    UpdatedAt = NOW()
WHERE ProofID = @proof_id;

-- Если одобрено, обновляем навык пользователя
IF @decision = 'Approved' THEN
    UPDATE UserSkills
    SET IsVerified = TRUE,
        VerifiedAt = NOW(),
        UpdatedAt = NOW()
    WHERE AccountID = (SELECT AccountID FROM Proofs WHERE ProofID = @proof_id)
      AND SkillID = (SELECT SkillID FROM Proofs WHERE ProofID = @proof_id);
END IF;

-- Обновление запроса на верификацию
UPDATE VerificationRequests
SET Status = @decision,
    ReviewedBy = @admin_id,
    ReviewedAt = NOW(),
    ReviewNotes = CONCAT('Документ проверен и ', LOWER(@decision)),
    UpdatedAt = NOW()
WHERE ProofID = @proof_id
  AND Status = 'Pending';

-- Логирование
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    Details,
    Result,
    CreatedAt
)
VALUES (
    @admin_id,
    'ProofVerified',
    'Proof',
    @proof_id,
    JSON_OBJECT('Decision', @decision, 'ProofID', @proof_id),
    'Success',
    NOW()
);

COMMIT;
```

### 11.4. Транзакция публикации поста с увеличением счетчика просмотров

```sql
START TRANSACTION;

SET @post_id = 1;

-- Увеличение счетчика просмотров (оптимистическая блокировка)
UPDATE SkillPosts
SET ViewsCount = ViewsCount + 1,
    UpdatedAt = NOW()
WHERE PostID = @post_id
  AND DeletedAt IS NULL;

-- Логирование просмотра
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    Result,
    CreatedAt
)
VALUES (
    NULL, -- может быть NULL для гостевых просмотров
    'PostViewed',
    'SkillPost',
    @post_id,
    'Success',
    NOW()
);

COMMIT;
```

### 11.5. Транзакция удаления пользователя (мягкое удаление)

```sql
START TRANSACTION;

SET @account_id = 1;

-- Мягкое удаление аккаунта
UPDATE Accounts
SET DeletedAt = NOW(),
    UpdatedAt = NOW()
WHERE AccountID = @account_id
  AND DeletedAt IS NULL;

-- Деактивация профиля
UPDATE UserProfiles
SET IsActive = FALSE,
    UpdatedAt = NOW()
WHERE AccountID = @account_id;

-- Закрытие всех активных постов пользователя
UPDATE SkillPosts
SET Status = 'Closed',
    DeletedAt = NOW(),
    UpdatedAt = NOW()
WHERE AccountID = @account_id
  AND Status = 'Active'
  AND DeletedAt IS NULL;

-- Логирование
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    Result,
    CreatedAt
)
VALUES (
    @account_id,
    'AccountDeleted',
    'Account',
    @account_id,
    'Success',
    NOW()
);

COMMIT;
```

### 11.6. Транзакция поиска партнеров для обмена знаниями

```sql
START TRANSACTION;

-- Поиск пользователей, которые ищут навык A и предлагают навык B
SET @requested_skill = 'Mathematical Analysis';
SET @offered_skill = 'Linear Algebra';
SET @user_id = 1;

-- Находим пользователей, которые:
-- 1. Ищут помощь с запрошенным навыком (Request)
-- 2. Предлагают помощь с предлагаемым навыком (Offer)
SELECT 
    sp_request.AccountID AS PartnerID,
    up.FullName AS PartnerName,
    up.Description AS PartnerDescription,
    sp_request.Title AS RequestTitle,
    sp_offer.Title AS OfferTitle,
    uc_public.ContactValue AS Contact
FROM SkillPosts sp_request
JOIN Accounts a ON sp_request.AccountID = a.AccountID
JOIN UserProfiles up ON a.AccountID = up.AccountID
JOIN SkillPosts sp_offer ON sp_request.AccountID = sp_offer.AccountID
LEFT JOIN UserContacts uc_public ON a.AccountID = uc_public.AccountID 
    AND uc_public.IsPublic = TRUE 
    AND uc_public.ContactType = 'Email'
WHERE sp_request.PostType = 'Request'
  AND sp_request.SkillID = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = @requested_skill)
  AND sp_request.Status = 'Active'
  AND sp_request.DeletedAt IS NULL
  AND sp_offer.PostType = 'Offer'
  AND sp_offer.SkillID = (SELECT SkillID FROM SkillsCatalog WHERE SkillName = @offered_skill)
  AND sp_offer.Status = 'Active'
  AND sp_offer.DeletedAt IS NULL
  AND a.DeletedAt IS NULL
  AND up.IsActive = TRUE
  AND sp_request.AccountID != @user_id
ORDER BY sp_request.CreatedAt DESC
LIMIT 10;

-- Логирование поиска
INSERT INTO AuditLog (
    ActorAccountID,
    Action,
    EntityType,
    EntityID,
    Details,
    Result,
    CreatedAt
)
VALUES (
    @user_id,
    'PartnerSearch',
    'Search',
    NULL,
    JSON_OBJECT('RequestedSkill', @requested_skill, 'OfferedSkill', @offered_skill),
    'Success',
    NOW()
);

COMMIT;
```

---

## 12. Заключение

В данной пояснительной записке представлена полная разработка системы обмена знаниями "KnowledgeForKnowledgeLite", предназначенной для студентов высших учебных заведений.

### 12.1. Основные достижения

1. **Проанализирована предметная область** и определены функциональные и нефункциональные требования к системе.

2. **Разработана нормализованная схема базы данных** до 4NF, что обеспечивает:
   - Отсутствие аномалий обновления, вставки и удаления
   - Минимальную избыточность данных
   - Целостность данных через внешние ключи и ограничения

3. **Определены функциональные и многозначные зависимости** между атрибутами сущностей.

4. **Создан SQL DDL скрипт** для реализации схемы базы данных со всеми ограничениями целостности.

5. **Разработаны SQL DML запросы** для реализации всех функциональных требований.

6. **Сгруппированы запросы в транзакции** для обеспечения атомарности операций и целостности данных.

### 12.2. Особенности системы

- **Гибкая система навыков** с категориями и уровнями владения
- **Верификация навыков** через документы с проверкой администраторами
- **Двусторонний обмен** предложений и запросов на помощь
- **Полный аудит действий** пользователей для безопасности
- **Мягкое удаление** для сохранения истории данных

### 12.3. Возможности для дальнейшего развития

1. Добавление системы рейтингов и отзывов пользователей
2. Реализация встроенной системы сообщений
3. Добавление календаря для планирования занятий
4. Интеграция с системами видеосвязи
5. Мобильное приложение для удобного доступа

Система готова к реализации и может быть использована студентами для взаимопомощи в обучении на основе принципа бартера знаний.

---

**Конец пояснительной записки**


